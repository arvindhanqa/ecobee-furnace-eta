@page "/"
@using EcobeeFurnaceEta.Blazor.Components
@using EcobeeFurnaceEta.Blazor.Models
@using EcobeeFurnaceEta.Blazor.Services
@inject EcobeeApiClient ApiClient
@inject EcobeeAuthService AuthService
@inject SecureTokenStorage TokenStorage
@inject PredictionEngine PredictionEngine

@if (!_showDashboard)
{
    <EcobeeAuth OnAuthenticated="HandleAuthenticated" OnSkipped="HandleSkipped" />
}
else
{
    <div class="dashboard">
        <header class="dashboard-header">
            <h1>FURNACE ETA</h1>
            <div class="header-right">
                <span class="thermostat-name">@_thermostatData?.Name</span>
                @if (_isLiveData)
                {
                    <span class="live-badge" title="Connected to Ecobee">LIVE</span>
                }
                else
                {
                    <span class="demo-badge" title="Using demo data">DEMO</span>
                }
                <button class="btn-icon" @onclick="ShowSettings" title="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                </button>
            </div>
        </header>

        @if (_isLoading)
        {
            <div class="loading">Loading thermostat data...</div>
        }
        else if (_thermostatData != null && _prediction != null)
        {
            <main class="dashboard-content">
                <section class="eta-section">
                    <ETACountdown Prediction="_prediction" TargetTempF="_thermostatData.SetpointF" />
                </section>

                <section class="gauge-section">
                    <TempGauge
                        OutdoorTempF="_thermostatData.OutdoorTempF"
                        CurrentTempF="_thermostatData.CurrentTempF"
                        TargetTempF="_thermostatData.SetpointF" />
                </section>

                <section class="curve-section">
                    <TempCurve
                        Projections="_prediction.Projections"
                        CurrentTempF="_thermostatData.CurrentTempF"
                        TargetTempF="_thermostatData.SetpointF"
                        OutdoorTempF="_thermostatData.OutdoorTempF" />
                </section>

                <section class="stats-section">
                    <StatsPanel Prediction="_prediction" />
                </section>

                <section class="schedule-section">
                    <ScheduleTimeline Schedule="_schedule" />
                </section>
            </main>

            <footer class="dashboard-footer">
                <span class="outdoor-temp">
                    Outside: @_thermostatData.OutdoorTempF.ToString("F1")°F
                    (@FahrenheitToCelsius(_thermostatData.OutdoorTempF).ToString("F1")°C)
                </span>
                <span class="humidity">Humidity: @_thermostatData.HumidityPercent.ToString("F0")%</span>
                <span class="last-update">Updated: @_thermostatData.Timestamp.ToString("HH:mm:ss")</span>
                <button class="btn-refresh" @onclick="RefreshData" title="Refresh">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                </button>
            </footer>
        }
    </div>
}

@if (_showSettingsModal)
{
    <div class="modal-overlay" @onclick="CloseSettings">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h2>Settings</h2>

            <div class="setting-item">
                <label>Connection Status</label>
                <p>@(_isLiveData ? "Connected to Ecobee" : "Using Demo Data")</p>
            </div>

            <div class="setting-actions">
                @if (_isLiveData)
                {
                    <button class="btn btn-danger" @onclick="HandleDisconnect">
                        Disconnect from Ecobee
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" @onclick="HandleConnectEcobee">
                        Connect to Ecobee
                    </button>
                }
            </div>

            <button class="btn btn-secondary" @onclick="CloseSettings">Close</button>
        </div>
    </div>
}

@code {
    private ThermostatData? _thermostatData;
    private HeatUpProfile? _heatUpProfile;
    private FurnacePrediction? _prediction;
    private List<ScheduleEvent> _schedule = new();
    private bool _isLoading = true;
    private bool _showDashboard = false;
    private bool _isLiveData = false;
    private bool _showSettingsModal = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if already authenticated
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            _showDashboard = true;
            _isLiveData = true;
            await LoadDataAsync();
        }
    }

    private async Task HandleAuthenticated()
    {
        _showDashboard = true;
        _isLiveData = true;
        await LoadDataAsync();
    }

    private async Task HandleSkipped()
    {
        _showDashboard = true;
        _isLiveData = false;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _thermostatData = await ApiClient.GetThermostatDataAsync();
            _heatUpProfile = await ApiClient.GetHeatUpProfileAsync();
            _schedule = await ApiClient.GetTodayScheduleAsync();

            if (_thermostatData != null && _heatUpProfile != null)
            {
                _prediction = PredictionEngine.Predict(_thermostatData, _heatUpProfile);
            }
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        await LoadDataAsync();
    }

    private void ShowSettings()
    {
        _showSettingsModal = true;
    }

    private void CloseSettings()
    {
        _showSettingsModal = false;
    }

    private async Task HandleDisconnect()
    {
        await AuthService.LogoutAsync();
        _isLiveData = false;
        _showSettingsModal = false;
        _showDashboard = false;
    }

    private void HandleConnectEcobee()
    {
        _showSettingsModal = false;
        _showDashboard = false;
    }

    private static double FahrenheitToCelsius(double fahrenheit)
    {
        return (fahrenheit - 32) * 5 / 9;
    }
}
