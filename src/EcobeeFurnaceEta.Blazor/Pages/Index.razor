@page "/"
@using EcobeeFurnaceEta.Blazor.Components
@using EcobeeFurnaceEta.Blazor.Models
@using EcobeeFurnaceEta.Blazor.Services
@implements IDisposable
@inject EcobeeApiClient ApiClient
@inject EcobeeAuthService AuthService
@inject SecureTokenStorage TokenStorage
@inject PredictionEngine PredictionEngine
@inject RuntimeStatsCache StatsCache

@if (!_showDashboard)
{
    <EcobeeAuth OnAuthenticated="HandleAuthenticated" OnSkipped="HandleSkipped" />
}
else
{
    <div class="dashboard">
        <header class="dashboard-header">
            <h1>FURNACE ETA</h1>
            <div class="header-right">
                <span class="thermostat-name">@_thermostatData?.Name</span>
                @if (_isLiveData)
                {
                    <span class="live-badge" title="Connected to Ecobee - Auto-refresh every 5s">LIVE</span>
                }
                else
                {
                    <span class="demo-badge" title="Using demo data">DEMO</span>
                }
                <button class="btn-icon" @onclick="ShowSettings" title="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                </button>
            </div>
        </header>

        @if (_isLoading && _thermostatData == null)
        {
            <div class="loading">Loading thermostat data...</div>
        }
        else if (_thermostatData != null && _prediction != null)
        {
            <main class="dashboard-cards">
                <!-- Row 1: Status Cards -->
                <div class="card-row">
                    <FurnaceStatusCard
                        Stats="@_runtimeStats"
                        MinutesToFurnaceOn="@((int)_prediction.MinutesToFurnaceOn)" />

                    <TemperatureCard
                        CurrentTempF="@_thermostatData.CurrentTempF"
                        SetpointF="@_thermostatData.SetpointF"
                        OutdoorTempF="@_thermostatData.OutdoorTempF"
                        HumidityPercent="@_thermostatData.HumidityPercent" />
                </div>

                <!-- Row 2: ETA and Stats -->
                <div class="card-row">
                    <ETACard
                        MinutesToTarget="@((int)_prediction.MinutesToTarget)"
                        CurrentTempF="@_thermostatData.CurrentTempF"
                        TargetTempF="@_thermostatData.SetpointF"
                        EffectiveRate="@_prediction.EffectiveRatePerMin"
                        IsAtTarget="@(_thermostatData.CurrentTempF >= _thermostatData.SetpointF)" />

                    <RuntimeStatsCard Stats="@_runtimeStats" />
                </div>

                <!-- Row 3: Projection -->
                <div class="card-row single">
                    <ProjectedRuntimeCard Stats="@_runtimeStats" />
                </div>
            </main>

            <footer class="dashboard-footer">
                <span class="last-update">
                    Updated: @_thermostatData.Timestamp.ToString("HH:mm:ss")
                    @if (_isRefreshing)
                    {
                        <span class="refresh-indicator"></span>
                    }
                </span>
                <span class="auto-refresh">Auto-refresh: @(_autoRefreshEnabled ? "ON" : "OFF")</span>
                <button class="btn-refresh" @onclick="RefreshData" title="Refresh now">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="@(_isRefreshing ? "spinning" : "")">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                </button>
            </footer>
        }
    </div>
}

@if (_showSettingsModal)
{
    <div class="modal-overlay" @onclick="CloseSettings">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h2>Settings</h2>

            <div class="setting-item">
                <label>Connection Status</label>
                <p>@(_isLiveData ? "Connected to Ecobee" : "Using Demo Data")</p>
            </div>

            <div class="setting-item">
                <label>Auto-Refresh (5 seconds)</label>
                <button class="btn @(_autoRefreshEnabled ? "btn-secondary" : "btn-primary")"
                        @onclick="ToggleAutoRefresh">
                    @(_autoRefreshEnabled ? "Disable" : "Enable")
                </button>
            </div>

            <div class="setting-actions">
                @if (_isLiveData)
                {
                    <button class="btn btn-danger" @onclick="HandleDisconnect">
                        Disconnect from Ecobee
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" @onclick="HandleConnectEcobee">
                        Connect to Ecobee
                    </button>
                }
            </div>

            <button class="btn btn-secondary" @onclick="CloseSettings">Close</button>
        </div>
    </div>
}

@code {
    private ThermostatData? _thermostatData;
    private HeatUpProfile? _heatUpProfile;
    private FurnacePrediction? _prediction;
    private RuntimeStats _runtimeStats = new();
    private bool _isLoading = true;
    private bool _isRefreshing = false;
    private bool _showDashboard = false;
    private bool _isLiveData = false;
    private bool _showSettingsModal = false;
    private bool _autoRefreshEnabled = true;
    private System.Threading.Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            _showDashboard = true;
            _isLiveData = true;
            await LoadDataAsync();
            StartAutoRefresh();
        }
    }

    private void StartAutoRefresh()
    {
        if (_autoRefreshEnabled && _isLiveData)
        {
            _refreshTimer?.Dispose();
            _refreshTimer = new System.Threading.Timer(
                async _ => await InvokeAsync(RefreshDataSilent),
                null,
                TimeSpan.FromSeconds(5),
                TimeSpan.FromSeconds(5));
        }
    }

    private void StopAutoRefresh()
    {
        _refreshTimer?.Dispose();
        _refreshTimer = null;
    }

    private void ToggleAutoRefresh()
    {
        _autoRefreshEnabled = !_autoRefreshEnabled;
        if (_autoRefreshEnabled)
        {
            StartAutoRefresh();
        }
        else
        {
            StopAutoRefresh();
        }
    }

    private async Task HandleAuthenticated()
    {
        _showDashboard = true;
        _isLiveData = true;
        await LoadDataAsync();
        StartAutoRefresh();
    }

    private async Task HandleSkipped()
    {
        _showDashboard = true;
        _isLiveData = false;
        _autoRefreshEnabled = false;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _thermostatData = await ApiClient.GetThermostatDataAsync();
            _heatUpProfile = await ApiClient.GetHeatUpProfileAsync();

            // Get runtime stats and merge with cache to preserve historical data
            var newStats = await ApiClient.GetRuntimeStatsAsync();
            _runtimeStats = await StatsCache.MergeWithCacheAsync(newStats);

            if (_thermostatData != null && _heatUpProfile != null)
            {
                _prediction = PredictionEngine.Predict(_thermostatData, _heatUpProfile);
            }
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshDataSilent()
    {
        if (_isRefreshing) return;

        _isRefreshing = true;
        StateHasChanged();

        try
        {
            _thermostatData = await ApiClient.GetThermostatDataAsync();

            // Get runtime stats and merge with cache to preserve historical data
            var newStats = await ApiClient.GetRuntimeStatsAsync();
            _runtimeStats = await StatsCache.MergeWithCacheAsync(newStats);

            if (_thermostatData != null && _heatUpProfile != null)
            {
                _prediction = PredictionEngine.Predict(_thermostatData, _heatUpProfile);
            }
        }
        finally
        {
            _isRefreshing = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        await RefreshDataSilent();
    }

    private void ShowSettings()
    {
        _showSettingsModal = true;
    }

    private void CloseSettings()
    {
        _showSettingsModal = false;
    }

    private async Task HandleDisconnect()
    {
        StopAutoRefresh();
        await AuthService.LogoutAsync();
        _isLiveData = false;
        _showSettingsModal = false;
        _showDashboard = false;
    }

    private void HandleConnectEcobee()
    {
        _showSettingsModal = false;
        _showDashboard = false;
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
